#!/usr/bin/perl -w
#    Copyright (c) 2011 RaphaÃ«l Pinson.
#
#    This library is free software; you can redistribute it and/or
#    modify it under the terms of the GNU Lesser Public License as
#    published by the Free Software Foundation; either version 2.1 of
#    the License, or (at your option) any later version.
#
#    Config-Model is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#    Lesser Public License for more details.
#
#    You should have received a copy of the GNU Lesser Public License
#    along with Config-Model; if not, write to the Free Software
#    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
#    02110-1301 USA


use strict;
use Getopt::Long;
use Pod::Usage;
use Config::Augeas::Validator;


################
# Parse options
################

my $conffile = "augeas-validator.ini";
my $verbose = 0;
my $man = 0;
my $help = 0;

my $opts = GetOptions(
   'help|?'  => \$help,
   'man'     => \$man,
   "verbose" => \$verbose,,
   "conf=s"    => \$conffile,
) or pod2usage(2);
pod2usage(1) if $help;
pod2usage(-exitstatus => 0, -verbose => 2) if $man;

my @files = @ARGV;

my $validator = Config::Augeas::Validator->new(conf => $conffile);
$validator->play_all(@files);
exit $validator->{err};


__END__

=head1 NAME

   augeas-validator - A generic configuration validator

=head1 SYNOPSIS

   augeas-validator [options] [file ...]

    Options:
      -help brief help message
      -man full documentation
      -verbose be verbose

=head1 OPTIONS

=over 8

=item B<-help>

Print a brief help message and exits.

=item B<-man>

Prints the manual page and exits.

=item B<-verbose>

Print verbose information.

=back

=head1 DESCRIPTION

B<Augeas-validator> is a generic configuration validator based on B<Augeas>. It takes a configuration file (by default F<augeas-validator.ini>) which contains a set of rules for a given B<Augeas> lens and applies them to the given files.

=head1 CONFIGURATION

The B<Augeas-validator> configuration files are INI files.

=head2 DEFAULT SECTION

The B<DEFAULT> section is mandatory. It contains the following variables:

=over 8

=item B<rules>

The ordered list of the rules to run, separated with commas, for example:

C<rules=app_type, ai_bo_auth, dr_auth>

=item B<lens>

The name of the lens to use, for example:

C<lens=Httpd>

=item B<err_code>

The exit code to return when a test fails. This parameter is optional. Example:

C<err_code=3>


=head2 RULES

Each section apart from the B<DEFAULT> section defines a rule, as listed in the B<rules> variable of the B<DEFAULT> section. Each rule contains several parameters.

=item B<name>

The rule description, for example:

C<name=Application Type>

=item B<explanation>

The explanation for the rule, for example:

C<explanation=Check that application type is FOO or BAR>

=item B<type>

The type of rule. For now, B<Augeas-validator> only supports the B<count> type, which returns the count nodes matching B<expr>. Example:

C<type=count>

=item B<expr>

The B<Augeas> expression for the rule. The C<$file> variable is the path to the file in the B<Augeas> tree. Example:

C<expr=$file/VirtualHost[#comment =~ regexp("^1# +((AI|BO)\+?|DR)$")]>

=item B<value>

The value expected for the test. For example, if using the count type, the number of matches expected for the expression. Example:

C<value=1>


=back


=head1 SEE ALSO

L<Config::Augeas>

=head1 FILES

F<augeas-validator.ini>
    The default configuration file for B<Augeas-validator>.

=cut



